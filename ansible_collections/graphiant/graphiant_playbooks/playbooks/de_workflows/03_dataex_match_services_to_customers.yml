---
# Data Exchange Management Playbook
# This playbook demonstrates how to use the graphiant_data_exchange module
# for managing Data Exchange services and customers matches.

- name: Data Exchange Management
  hosts: localhost
  gather_facts: false
  vars:
    # graphiant_host: "https://api.graphiant.com"
    # graphiant_username: "{{ vault_graphiant_username }}"
    # graphiant_password: "{{ vault_graphiant_password }}"

    # Use YAML anchors to avoid repetition
    graphiant_client_params: &graphiant_client_params
      host: "{{ graphiant_host | default(lookup('env', 'GRAPHIANT_HOST')) }}"
      username: "{{ graphiant_username | default(lookup('env', 'GRAPHIANT_USERNAME')) }}"
      password: "{{ graphiant_password | default(lookup('env', 'GRAPHIANT_PASSWORD')) }}"
      # host: "{{ graphiant_host | default(lookup('ini', 'url file=/absolute/path/test/test.ini section=host')) }}"
      # username: "{{ graphiant_username | default(lookup('ini', 'username file=/absolute/path/test/test.ini section=credentials')) }}"
      # password: "{{ graphiant_password | default(lookup('ini', 'password file=/absolute/path/test/test.ini section=credentials')) }}"

  tasks:
    - name: Get Data Exchange services summary
      graphiant.graphiant_playbooks.graphiant_data_exchange:
        <<: *graphiant_client_params
        operation: get_services_summary
        detailed_logs: true
      register: services_summary

    - name: Display services summary
      ansible.builtin.debug:
        msg: "{{ services_summary.result_msg }}"

    - name: Get Data Exchange customers summary
      graphiant.graphiant_playbooks.graphiant_data_exchange:
        <<: *graphiant_client_params
        operation: get_customers_summary
        detailed_logs: true
      register: customers_summary

    - name: Display customers summary
      ansible.builtin.debug:
        msg: "{{ customers_summary.result_msg }}"

    - name: Match Data Exchange services to customers
      graphiant.graphiant_playbooks.graphiant_data_exchange:
        <<: *graphiant_client_params
        operation: match_service_to_customers
        config_file: "de_workflows_configs/sample_data_exchange_matches.yaml"
        # config_file: "de_workflows_configs/sample_data_exchange_matches_scale.yaml" # Scale testing
        # config_file: "de_workflows_configs/sample_data_exchange_matches_scale2.yaml" # Scale testing2
        detailed_logs: true
      register: match_result

    - name: Display match result
      ansible.builtin.debug:
        msg: "{{ match_result.result_msg }}"

    - name: Get updated customers summary
      graphiant.graphiant_playbooks.graphiant_data_exchange:
        <<: *graphiant_client_params
        operation: get_customers_summary
        detailed_logs: true
      register: updated_customers_summary

    - name: Display updated customers count
      ansible.builtin.debug:
        msg: "{{ updated_customers_summary.result_msg }}"
