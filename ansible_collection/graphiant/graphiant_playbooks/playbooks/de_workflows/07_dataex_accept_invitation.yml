---
# Data Exchange Accept Invitation Playbook (Workflow 4)
# This playbook demonstrates how to accept Data Exchange service invitations
# for non-Graphiant customers with gateway deployment and VPN configuration

- name: Data Exchange Accept Invitation (Workflow 4)
  hosts: localhost
  gather_facts: false
  vars:
    #graphiant_host: "https://api.graphiant.com"
    #graphiant_username: "{{ vault_graphiant_username }}"
    #graphiant_password: "{{ vault_graphiant_password }}"
    
    # Use YAML anchors to avoid repetition
    graphiant_client_params: &graphiant_client_params
      host: "{{ graphiant_host | default(lookup('env', 'GRAPHIANT_HOST')) }}"
      username: "{{ graphiant_username | default(lookup('env', 'GRAPHIANT_USERNAME')) }}"
      password: "{{ graphiant_password | default(lookup('env', 'GRAPHIANT_PASSWORD')) }}"
      #host: "{{ graphiant_host | default(lookup('ini', 'url file=/absolute/path/test/test.ini section=host')) }}"
      #username: "{{ graphiant_username | default(lookup('ini', 'username file=/absolute/path/test/test.ini section=credentials')) }}"
      #password: "{{ graphiant_password | default(lookup('ini', 'password file=/absolute/path/test/test.ini section=credentials')) }}"

  tasks:

    - name: Get Data Exchange services summary
      graphiant.graphiant_playbooks.graphiant_data_exchange:
        <<: *graphiant_client_params
        operation: get_services_summary
        detailed_logs: true
      register: services_summary

    - name: Display services summary
      debug:
        msg: "{{ services_summary.result_msg }}"

    - name: Accept Data Exchange service invitation (Dry Run)
      graphiant.graphiant_playbooks.graphiant_data_exchange:
        <<: *graphiant_client_params
        operation: accept_invitation
        config_file: "de_workflows_configs/sample_data_exchange_acceptance.yaml"
        matches_file: "ansible_collection/graphiant/graphiant_playbooks/playbooks/de_workflows/de_workflows_configs/output/sample_data_exchange_matches_responses_latest.json"
        #config_file: "de_workflows_configs/sample_data_exchange_acceptance_scale.yaml" # Scale testing
        #matches_file: "ansible_collection/graphiant/graphiant_playbooks/playbooks/de_workflows/de_workflows_configs/output/sample_data_exchange_matches_scale_responses_latest.json" # Scale testing
        dry_run: true
        detailed_logs: true
      register: accept_dry_run_result 

    - name: Display acceptance result
      debug:
        msg: "{{ accept_dry_run_result.result_msg }}"
  
    - name: Accept Data Exchange service invitation
      graphiant.graphiant_playbooks.graphiant_data_exchange:
        <<: *graphiant_client_params
        operation: accept_invitation
        config_file: "de_workflows_configs/sample_data_exchange_acceptance.yaml"
        matches_file: "ansible_collection/graphiant/graphiant_playbooks/playbooks/de_workflows/de_workflows_configs/output/sample_data_exchange_matches_responses_latest.json"
        #config_file: "de_workflows_configs/sample_data_exchange_acceptance_scale.yaml" # Scale testing
        #matches_file: "ansible_collection/graphiant/graphiant_playbooks/playbooks/de_workflows/de_workflows_configs/output/sample_data_exchange_matches_scale_responses_latest.json" # Scale testing
        detailed_logs: true
      register: accept_result

    - name: Display acceptance result
      debug:
        msg: "{{ accept_result.result_msg }}"

    - name: Get updated Data Exchange services summary
      graphiant.graphiant_playbooks.graphiant_data_exchange:
        <<: *graphiant_client_params
        operation: get_services_summary
        detailed_logs: true
      register: updated_services_summary

    - name: Display updated services summary
      debug:
        msg: "{{ updated_services_summary.result_msg }}"